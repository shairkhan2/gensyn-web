<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gensyn Peer Tracker</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Gensyn Peer Tracker</h1>
    <button id="theme-toggle" aria-label="Toggle dark/light mode">üåô</button>
  </header>
  <div id="top-rewards-banner">
    <div id="rewards-slider"></div>
  </div>
      <div id="announcement" class="announcement">
      <div class="announcement-content">
        <div class="owner-info">
          <span class="owner-title">Owner of Site</span>
          <div class="telegram-link">
            <span class="telegram-icon">üì±</span>
            <a href="https://t.me/Shair25" target="_blank" class="owner-name">SHAIR</a>
          </div>
        </div>
      </div>
      <button id="close-announcement" aria-label="Close announcement">&times;</button>
    </div>
    
    <!-- Email Modal -->
    <div id="email-modal" class="email-modal">
      <div class="email-modal-content">
        <div class="email-modal-header">
          <h3>üîê Email-Based Peer Storage</h3>
          <button class="close-modal" onclick="closeEmailModal()">&times;</button>
        </div>
        <div class="email-modal-body">
          <p>Enter your email to save/load your peer data across browsers:</p>
          <div class="email-input-group">
            <input type="email" id="user-email" placeholder="your@email.com" class="email-input">
            <button onclick="savePeersToEmail()" class="email-btn save-btn">üíæ Save Peers</button>
            <button onclick="loadPeersFromEmail()" class="email-btn load-btn">üì• Load Peers</button>
          </div>
          <div id="email-status" class="email-status"></div>
        </div>
      </div>
    </div>
    

  <main>
    <section id="stats">
      <h2>Network Stats</h2>
      <div id="stats-content">
        <p>Loading stats...</p>
      </div>
    </section>
    <section id="saved-peers">
      <div class="saved-peers-header">
        <h2>My Saved Peers</h2>
        <button onclick="openEmailModal()" class="email-sync-btn-small">
          üìß Sync
        </button>
      </div>
      <div id="saved-peers-content">
        <p>No saved peers yet. Search for peers to save them!</p>
      </div>
    </section>
    <section id="peer-search">
      <h2>Search Peer</h2>
      <form id="search-form">
        <input type="text" id="search-input" placeholder="Enter peer name or ID" required>
        <button type="submit">Search</button>
      </form>
      <div id="peer-detail" class="peer-detail" style="display:none;"></div>
    </section>
    <section id="leaderboard">
      <h2>Leaderboard</h2>
      <div id="leaderboard-content">
        <p>Loading leaderboard...</p>
      </div>
    </section>
  </main>
  <footer>
    <p>&copy; 2024 Gensyn Peer Tracker</p>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <script>
    // Set default theme to dark
    document.body.classList.add('dark-mode');
    
    // Dark/Light mode toggle
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.textContent = '‚òÄÔ∏è'; // Start with sun icon since dark mode is default
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    });
    // Announcement close
    document.getElementById('close-announcement').onclick = function() {
      document.getElementById('announcement').style.display = 'none';
    };

    // Peer search functionality
    document.getElementById('search-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;
      let peerData = null;
      let peerId = null;
      let eoa = null;
      let isEoa = false;
      const detailDiv = document.getElementById('peer-detail');
      detailDiv.style.display = 'block';
      detailDiv.textContent = 'Loading...';
      // Helper: fetch EOA from contract
      async function fetchEoaForPeer(peerId) {
        try {
          console.log('Fetching EOA for peerId:', peerId);
          const provider = new ethers.JsonRpcProvider("https://gensyn-testnet.g.alchemy.com/v2/TD5tr7mo4VfXlSaolFlSr3tL70br2M9J");
          const contract = new ethers.Contract(
            "0xFaD7C5e93f28257429569B854151A1B8DCD404c2",
            [
              {
                "name": "getEoa",
                "type": "function",
                "stateMutability": "view",
                "inputs": [{ "name": "peerIds", "type": "string[]" }],
                "outputs": [{ "name": "", "type": "address[]" }]
              }
            ],
            provider
          );
          const addresses = await contract.getEoa([peerId]);
          console.log('Contract response:', addresses);
          const eoa = addresses[0];
          console.log('EOA address:', eoa);
          return eoa;
        } catch (error) {
          console.error('Error fetching EOA from contract:', error);
          return null;
        }
      }
      // If input looks like an EOA address
      if (query.startsWith('0x') && query.length === 42) {
        isEoa = true;
        eoa = query;
        
        try {
                  // Search for peer info for this EOA address in the leaderboard
        console.log("Searching leaderboard for EOA address");
        const corsProxy = 'https://api.allorigins.win/raw?url=';
        const leaderboardUrl = corsProxy + 'https://dashboard.gensyn.ai/api/v1/leaderboard';
          const res = await fetch(leaderboardUrl);
          if (res.ok) {
            const data = await res.json();
            const entries = data.entries || [];
            const matchingPeer = entries.find(peer => peer.eoa && peer.eoa.toLowerCase() === eoa.toLowerCase());
            
            if (matchingPeer) {
              // Found peer info for this EOA
              detailDiv.innerHTML = `
                <div class="peer-card">
                  <div class="peer-header">
                    <div class="peer-avatar">${matchingPeer.peerName.charAt(0).toUpperCase()}</div>
                    <div class="peer-info">
                      <h3 class="peer-name">${matchingPeer.peerName}</h3>
                      <span class="peer-status ${matchingPeer.online ? 'online' : 'offline'}">${matchingPeer.online ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                    </div>
                  </div>
                  <div class="peer-stats">
                    <div class="stat-item-cool">
                      <span class="stat-icon">üèÜ</span>
                      <span class="stat-label-cool">Reward</span>
                      <span class="stat-value-cool">${matchingPeer.reward.toLocaleString()}</span>
                    </div>
                    <div class="stat-item-cool">
                      <span class="stat-icon">üìä</span>
                      <span class="stat-label-cool">Score</span>
                      <span class="stat-value-cool">${matchingPeer.score.toLocaleString()}</span>
                    </div>
                  </div>
                  <div class="peer-details">
                    <div class="detail-item">
                      <span class="detail-label">Peer ID</span>
                      <span class="detail-value">${matchingPeer.peerId}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">EOA Address</span>
                      <span class="detail-value">${eoa}</span>
                    </div>
                  </div>
                  <div class="peer-footer">
                    <span class="success-badge">‚úì Found via leaderboard search</span>
                  </div>
                </div>
              `;
            } else {
              detailDiv.innerHTML = `
                <div class="peer-card">
                  <strong>EOA Address:</strong> ${eoa}<br>
                  <span style='color:orange'>‚ö† No peer information found for this EOA address</span><br>
                  <span style='color:gray'>This EOA address is not associated with any peer in the current data.</span>
                </div>
              `;
            }
          } else {
            throw new Error('Failed to fetch leaderboard data');
          }
        } catch (err) {
          detailDiv.innerHTML = `
            <div class="peer-card">
              <strong>EOA Address:</strong> ${eoa}<br>
              <span style='color:red'>Error fetching peer information: ${err.message}</span>
            </div>
          `;
        }
        return;
      }
      // Use CORS proxy for local development. Remove for production!
      // Production: No CORS proxy needed
      const corsProxy = 'https://api.allorigins.win/raw?url=';
      try {
        // If input looks like a peerId
        if (query.startsWith('Qm')) {
          // Fetch peer info from dashboard API
          let url = corsProxy + `https://dashboard.gensyn.ai/api/v1/peer?id=${encodeURIComponent(query)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Peer not found');
          peerData = await res.json();
          peerId = peerData.peerId;
        } else {
          // Assume it's a peer name, fetch info
          let url = corsProxy + `https://dashboard.gensyn.ai/api/v1/peer?name=${encodeURIComponent(query)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Peer not found');
          peerData = await res.json();
          peerId = peerData.peerId;
        }
        // Now fetch EOA from contract
        eoa = await fetchEoaForPeer(peerId);
        
        // If contract call failed, try to find EOA in leaderboard data
        if (!eoa || eoa === '0x0000000000000000000000000000000000000000') {
          console.log('Contract call failed or returned zero address, trying leaderboard search...');
          try {
            const leaderboardUrl = corsProxy + 'https://dashboard.gensyn.ai/api/v1/leaderboard';
            const leaderboardRes = await fetch(leaderboardUrl);
            if (leaderboardRes.ok) {
              const leaderboardData = await leaderboardRes.json();
              const entries = leaderboardData.entries || [];
              const matchingPeer = entries.find(peer => peer.peerId === peerId);
              if (matchingPeer && matchingPeer.eoa) {
                eoa = matchingPeer.eoa;
                console.log('Found EOA in leaderboard:', eoa);
              }
            }
          } catch (err) {
            console.error('Error searching leaderboard for EOA:', err);
          }
        }
        
        // Add EOA to peerData before saving
        peerData.eoa = eoa;
        
        // Save peer data automatically
        savePeerData(peerData);
        
        detailDiv.innerHTML = `
          <div class="peer-card">
            <div class="peer-header">
              <div class="peer-avatar">${peerData.peerName.charAt(0).toUpperCase()}</div>
              <div class="peer-info">
                <h3 class="peer-name">${peerData.peerName}</h3>
                <span class="peer-status ${peerData.online ? 'online' : 'offline'}">${peerData.online ? 'üü¢ Online' : 'üî¥ Offline'}</span>
              </div>
            </div>
            <div class="peer-stats">
              <div class="stat-item-cool">
                <span class="stat-icon">üèÜ</span>
                <span class="stat-label-cool">Reward</span>
                <span class="stat-value-cool">${peerData.reward.toLocaleString()}</span>
              </div>
              <div class="stat-item-cool">
                <span class="stat-icon">üìä</span>
                <span class="stat-label-cool">Score</span>
                <span class="stat-value-cool">${peerData.score.toLocaleString()}</span>
              </div>
            </div>
            <div class="peer-details">
              <div class="detail-item">
                <span class="detail-label">Peer ID</span>
                <span class="detail-value">${peerData.peerId}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">EOA Address</span>
                <span class="detail-value">${eoa || 'Not available'}</span>
              </div>
            </div>
            <div class="peer-footer">
              <span class="success-badge">‚úì Found via smart contract & Saved!</span>
            </div>
          </div>
        `;
      } catch (err) {
        console.error('Search error:', err);
        detailDiv.innerHTML = `<span style="color:red">Peer not found or error fetching data: ${err.message}</span>`;
      }
    });

    // Move leaderboard to a sidebar on the right and show only top 10 peers with name, reward, and score
    // Update HTML structure
    const main = document.querySelector('main');
    if (!document.getElementById('main-content')) {
      const mainContent = document.createElement('div');
      mainContent.id = 'main-content';
      mainContent.style.display = 'flex';
      mainContent.style.gap = '2rem';
      mainContent.innerHTML = `
        <div id="main-sections" style="flex:1; min-width:0;"></div>
        <aside id="leaderboard-aside" style="width:260px; min-width:180px;"></aside>
      `;
      // Move all sections except leaderboard into main-sections
      const stats = document.getElementById('stats');
      const savedPeers = document.getElementById('saved-peers');
      const peerSearch = document.getElementById('peer-search');
      mainContent.querySelector('#main-sections').appendChild(savedPeers);
      mainContent.querySelector('#main-sections').appendChild(peerSearch);
      
      // Move stats to leaderboard aside and make it small
      const statsSection = document.getElementById('stats');
      statsSection.style.marginBottom = '1rem';
      mainContent.querySelector('#leaderboard-aside').insertBefore(statsSection, mainContent.querySelector('#leaderboard-aside').firstChild);
      // Move leaderboard section into aside
      const leaderboard = document.getElementById('leaderboard');
      mainContent.querySelector('#leaderboard-aside').appendChild(leaderboard);
      main.innerHTML = '';
      main.appendChild(mainContent);
    }
    // Leaderboard fetch and click-to-detail (Gensyn style) with caching and rate limiting
    async function fetchLeaderboard() {
      const leaderboardDiv = document.getElementById('leaderboard-content');
      console.log('Fetching leaderboard...');
      
      // Try to get cached data first
      const cachedData = getCachedData('leaderboard');
      console.log('Cached data:', cachedData ? 'Found' : 'Not found');
      
      if (cachedData) {
        console.log('Displaying cached leaderboard data');
        displayLeaderboard(cachedData);
      }
      
      // Check rate limit for leaderboard (15 min interval)
      if (isRateLimited('leaderboard') && cachedData) {
        console.log('Leaderboard rate limited, using cached data');
        return;
      }
      
      // Only show loading if no cached data
      if (!cachedData) {
        leaderboardDiv.innerHTML = 'Loading leaderboard...';
      }
      
      // Production: No CORS proxy needed
      const corsProxy = 'https://api.allorigins.win/raw?url=';
      const url = corsProxy + 'https://dashboard.gensyn.ai/api/v1/leaderboard';
      console.log('Fetching from:', url);
      
      try {
        const res = await fetch(url);
        console.log('Response status:', res.status);
        if (!res.ok) throw new Error('Failed to fetch leaderboard');
        const data = await res.json();
        console.log('Leaderboard data received:', data);
        
        // Cache the new data and set rate limit
        setCachedData('leaderboard', data);
        setRateLimit('leaderboard');
        
        displayLeaderboard(data);
      } catch (err) {
        console.error('Leaderboard fetch error:', err);
        // Only show error if no cached data available
        if (!cachedData) {
          leaderboardDiv.innerHTML = '<span style="color:red">Error loading leaderboard.</span>';
        }
      }
    }
    
    function displayLeaderboard(data) {
      const leaderboardDiv = document.getElementById('leaderboard-content');
      const entries = (data.entries || []).slice(0, 10);
      
      if (!Array.isArray(entries) || entries.length === 0) {
        leaderboardDiv.innerHTML = '<span style="color:red">No leaderboard data found.</span>';
        return;
      }
      
      let table = `<div class='gensyn-leaderboard-title'>Top 10 (Gensyn Leaderboard)</div>`;
      table += `<table class='gensyn-leaderboard-table'><thead><tr><th>Rank</th><th>Œî</th><th>Peer ID</th><th>Wins</th><th>Rewards</th></tr></thead><tbody>`;
      entries.forEach((peer, idx) => {
        let rank, delta;
        if (idx === 0) { rank = 'ü•á'; delta = '‚ñ≤1'; }
        else if (idx === 1) { rank = 'ü•à'; delta = '‚ñº1'; }
        else if (idx === 2) { rank = 'ü•â'; delta = '‚ñ≤1'; }
        else { rank = `#${idx + 1}`; delta = '‚Äì'; }
        // Shorten peerId for display
        const shortPeerId = peer.peerId.slice(0, 8);
        table += `<tr class='gensyn-leaderboard-row' data-peerid="${peer.peerId}">
          <td>${rank}</td>
          <td>${delta}</td>
          <td class='gensyn-peerid'>${shortPeerId}</td>
          <td>${peer.score.toLocaleString()}</td>
          <td>${peer.reward.toLocaleString()}</td>
        </tr>`;
      });
      table += '</tbody></table>';
      leaderboardDiv.innerHTML = table;
      
      // Add click listeners to rows
      document.querySelectorAll('.gensyn-leaderboard-row').forEach(row => {
        row.addEventListener('click', async function() {
          const peerId = this.getAttribute('data-peerid');
          document.getElementById('search-input').value = peerId;
          document.getElementById('search-form').dispatchEvent(new Event('submit'));
          window.scrollTo({ top: document.getElementById('peer-search').offsetTop - 20, behavior: 'smooth' });
        });
      });
    }
    
    // Data caching system with rate limiting
    const cacheKey = 'gensyn_cache_data';
    const cacheExpiry = 5 * 60 * 1000; // 5 minutes
    const rateLimitKey = 'gensyn_rate_limit';
    const rateLimitInterval = 15 * 60 * 1000; // 15 minutes for saved peers updates
    
    function getCachedData(key) {
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const data = JSON.parse(cached);
        if (data[key] && Date.now() - data[key].timestamp < cacheExpiry) {
          return data[key].value;
        }
      }
      return null;
    }
    
    function setCachedData(key, value) {
      const cached = localStorage.getItem(cacheKey);
      const data = cached ? JSON.parse(cached) : {};
      data[key] = {
        value: value,
        timestamp: Date.now()
      };
      localStorage.setItem(cacheKey, JSON.stringify(data));
    }
    
    // Rate limiting functions
    function isRateLimited(key) {
      const rateLimit = localStorage.getItem(rateLimitKey);
      if (rateLimit) {
        const limits = JSON.parse(rateLimit);
        const lastCall = limits[key] || 0;
        const now = Date.now();
        return (now - lastCall) < rateLimitInterval;
      }
      return false;
    }
    
    function setRateLimit(key) {
      const rateLimit = localStorage.getItem(rateLimitKey);
      const limits = rateLimit ? JSON.parse(rateLimit) : {};
      limits[key] = Date.now();
      localStorage.setItem(rateLimitKey, JSON.stringify(limits));
    }
    
    // Fetch leaderboard on page load
    fetchLeaderboard();
    
    // --- Fix for network stats property and debugging ---
    async function fetchNetworkStats() {
      const statsDiv = document.getElementById('stats-content');
      // Try to get cached data first
      const cachedData = getCachedData('networkStats');
      const cachedRoundData = getCachedData('roundData');
      
      if (cachedData && cachedRoundData) {
        const value = cachedData.connected !== undefined ? cachedData.connected : cachedData.count;
        statsDiv.innerHTML = `
          <div class="stats-card">
            <div class="stat-item">
              <span class="stat-label">Nodes Connected</span>
              <span class="stat-value">${value ? value.toLocaleString() : '?'}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Current Round</span>
              <span class="stat-value">${cachedRoundData.round}</span>
            </div>
          </div>
        `;
      }
      
      // Check rate limit for network stats (15 min interval)
      if (isRateLimited('networkStats') && cachedData && cachedRoundData) {
        console.log('Network stats rate limited, using cached data');
        return;
      }
      
      try {
        const corsProxy = 'https://api.allorigins.win/raw?url=';
        
        // Fetch nodes connected
        const nodesUrl = corsProxy + 'https://dashboard.gensyn.ai/api/v1/nodes-connected';
        const nodesRes = await fetch(nodesUrl);
        if (!nodesRes.ok) throw new Error('Failed to fetch network stats');
        const nodesData = await nodesRes.json();
        const value = nodesData.connected !== undefined ? nodesData.connected : nodesData.count;
        
        // Fetch round data
        const roundUrl = corsProxy + 'https://dashboard.gensyn.ai/api/v1/round-stage';
        const roundRes = await fetch(roundUrl);
        if (!roundRes.ok) throw new Error('Failed to fetch round data');
        const roundData = await roundRes.json();
        
        // Cache both data sets
        setCachedData('networkStats', nodesData);
        setCachedData('roundData', roundData);
        setRateLimit('networkStats');
        
        statsDiv.innerHTML = `
          <div class="stats-card">
            <div class="stat-item">
              <span class="stat-label">Nodes Connected</span>
              <span class="stat-value">${value ? value.toLocaleString() : '?'}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Current Round</span>
              <span class="stat-value">${roundData.round}</span>
            </div>
          </div>
        `;
      } catch (err) {
        if (!cachedData) {
          statsDiv.innerHTML = '<span style="color:red">Error loading network stats.</span>';
        }
        console.error('Network stats error:', err);
      }
    }
    
    // Peer data management
    const savedPeersKey = 'gensyn_saved_peers';
    
    function savePeerData(peerData) {
      const savedPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');
      const now = new Date().toISOString();
      
      if (savedPeers[peerData.peerId]) {
        // Update existing peer with new data
        const oldData = savedPeers[peerData.peerId];
        const rewardChange = peerData.reward - oldData.reward;
        const scoreChange = peerData.score - oldData.score;
        
        savedPeers[peerData.peerId] = {
          ...peerData,
          lastUpdated: now,
          previousData: {
            reward: oldData.reward,
            score: oldData.score,
            lastUpdated: oldData.lastUpdated
          },
          changes: {
            reward: rewardChange,
            score: scoreChange
          }
        };
      } else {
        // New peer
        savedPeers[peerData.peerId] = {
          ...peerData,
          lastUpdated: now,
          previousData: null,
          changes: {
            reward: 0,
            score: 0
          }
        };
      }
      
      localStorage.setItem(savedPeersKey, JSON.stringify(savedPeers));
      displaySavedPeers();
    }
    
    function displaySavedPeers() {
      const savedPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');
      const container = document.getElementById('saved-peers-content');
      
      if (Object.keys(savedPeers).length === 0) {
        container.innerHTML = '<p>No saved peers yet. Search for peers to save them!</p>';
        return;
      }
      
      const peerCount = Object.keys(savedPeers).length;
      let html = `<div class="saved-peers-grid" data-peer-count="${peerCount}">`;
      
      Object.values(savedPeers).forEach(peer => {
        const lastUpdated = new Date(peer.lastUpdated).toLocaleString();
        const rewardChange = peer.changes.reward;
        const scoreChange = peer.changes.score;
        
        html += `
          <div class="saved-peer-card" onclick="showSavedPeerDetails('${peer.peerId}')" style="cursor: pointer;">
            <div class="saved-peer-header">
              <div class="saved-peer-avatar">${peer.peerName.charAt(0).toUpperCase()}</div>
              <div class="saved-peer-info">
                <h4 class="saved-peer-name">${peer.peerName}</h4>
                <span class="saved-peer-status ${peer.online ? 'online' : 'offline'}">${peer.online ? 'üü¢ Online' : 'üî¥ Offline'}</span>
              </div>
              <button class="remove-peer-btn" onclick="event.stopPropagation(); removeSavedPeer('${peer.peerId}')">√ó</button>
            </div>
            <div class="saved-peer-stats">
              <div class="saved-stat-item">
                <span class="saved-stat-icon">üèÜ</span>
                <span class="saved-stat-label">Reward</span>
                <span class="saved-stat-value">${peer.reward.toLocaleString()}</span>
                ${rewardChange !== 0 ? `<span class="change-indicator ${rewardChange > 0 ? 'positive' : 'negative'}">${rewardChange > 0 ? '+' : ''}${rewardChange}</span>` : ''}
              </div>
              <div class="saved-stat-item">
                <span class="saved-stat-icon">üìä</span>
                <span class="saved-stat-label">Score</span>
                <span class="saved-stat-value">${peer.score.toLocaleString()}</span>
                ${scoreChange !== 0 ? `<span class="change-indicator ${scoreChange > 0 ? 'positive' : 'negative'}">${scoreChange > 0 ? '+' : ''}${scoreChange}</span>` : ''}
              </div>
            </div>
            <div class="saved-peer-footer">
              <span class="last-updated">Last updated: ${lastUpdated}</span>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    function removeSavedPeer(peerId) {
      const savedPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');
      delete savedPeers[peerId];
      localStorage.setItem(savedPeersKey, JSON.stringify(savedPeers));
      displaySavedPeers();
    }
    
    // Make removeSavedPeer globally accessible
    window.removeSavedPeer = removeSavedPeer;
    
    // Function to show saved peer details
    function showSavedPeerDetails(peerId) {
      const savedPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');
      const peer = savedPeers[peerId];
      
      if (!peer) return;
      
      // Create modal or update search results
      const detailDiv = document.getElementById('peer-detail');
      detailDiv.style.display = 'block';
      
      detailDiv.innerHTML = `
        <div class="peer-card">
          <div class="peer-header">
            <div class="peer-avatar">${peer.peerName.charAt(0).toUpperCase()}</div>
            <div class="peer-info">
              <h3 class="peer-name">${peer.peerName}</h3>
              <span class="peer-status ${peer.online ? 'online' : 'offline'}">${peer.online ? 'üü¢ Online' : 'üî¥ Offline'}</span>
            </div>
          </div>
          <div class="peer-stats">
            <div class="stat-item-cool">
              <span class="stat-icon">üèÜ</span>
              <span class="stat-label-cool">Reward</span>
              <span class="stat-value-cool">${peer.reward.toLocaleString()}</span>
            </div>
            <div class="stat-item-cool">
              <span class="stat-icon">üìä</span>
              <span class="stat-label-cool">Score</span>
              <span class="stat-value-cool">${peer.score.toLocaleString()}</span>
            </div>
          </div>
          <div class="peer-details">
            <div class="detail-item">
              <span class="detail-label">Peer ID</span>
              <span class="detail-value">${peer.peerId}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">EOA Address</span>
              <span class="detail-value">${peer.eoa || 'Not available'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Last Updated</span>
              <span class="detail-value">${new Date(peer.lastUpdated).toLocaleString()}</span>
            </div>
            ${peer.changes.reward !== 0 ? `
            <div class="detail-item">
              <span class="detail-label">Reward Change</span>
              <span class="detail-value ${peer.changes.reward > 0 ? 'positive' : 'negative'}">${peer.changes.reward > 0 ? '+' : ''}${peer.changes.reward}</span>
            </div>
            ` : ''}
            ${peer.changes.score !== 0 ? `
            <div class="detail-item">
              <span class="detail-label">Score Change</span>
              <span class="detail-value ${peer.changes.score > 0 ? 'positive' : 'negative'}">${peer.changes.score > 0 ? '+' : ''}${peer.changes.score}</span>
            </div>
            ` : ''}
          </div>
          <div class="peer-footer">
            <span class="success-badge">‚úì Saved Peer Details</span>
          </div>
        </div>
      `;
      
      // Scroll to the details
      detailDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Make showSavedPeerDetails globally accessible
    window.showSavedPeerDetails = showSavedPeerDetails;
    
    // Update saved peers with rate limiting (every 15 minutes)
    async function updateSavedPeers() {
      const savedPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');
      const peerIds = Object.keys(savedPeers);
      
      if (peerIds.length === 0) return;
      
      // Check rate limit for saved peers updates
      if (isRateLimited('savedPeersUpdate')) {
        console.log('Saved peers update rate limited');
        return;
      }
      
      console.log(`Updating ${peerIds.length} saved peers...`);
      
      for (const peerId of peerIds) {
        try {
          const response = await fetch(corsProxy + `https://dashboard.gensyn.ai/api/v1/peer?id=${peerId}`);
          if (response.ok) {
            const peerData = await response.json();
            savePeerData(peerData); // This will update the existing peer with new data
          }
        } catch (err) {
          console.error(`Error updating peer ${peerId}:`, err);
        }
        
        // Small delay between requests to be respectful
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // Set rate limit after updating all peers
      setRateLimit('savedPeersUpdate');
      console.log('Saved peers updated successfully');
    }
    
    // Update saved peers every 15 minutes
    setInterval(updateSavedPeers, 15 * 60 * 1000); // 15 minutes
    
    // Fetch stats on page load
    fetchNetworkStats();
    
    // Display saved peers on page load
    displaySavedPeers();
    
    // --- Fix for rewards slider visibility and animation ---
    async function fetchTopRewards() {
      const sliderDiv = document.getElementById('rewards-slider');
      
      // Try to get cached data first
      const cachedData = getCachedData('topRewards');
      if (cachedData) {
        displayTopRewards(cachedData);
      }
      
      // Check rate limit for top rewards (15 min interval)
      if (isRateLimited('topRewards') && cachedData) {
        console.log('Top rewards rate limited, using cached data');
        return;
      }
      
      try {
        const corsProxy = 'https://api.allorigins.win/raw?url=';
        const url = corsProxy + 'https://dashboard.gensyn.ai/api/v1/top-rewards';
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch top rewards');
        const data = await res.json();
        
        // Cache the new data and set rate limit
        setCachedData('topRewards', data);
        setRateLimit('topRewards');
        
        displayTopRewards(data);
      } catch (err) {
        console.error('Top rewards error:', err);
        // If API fails and no cached data, show error
        if (!cachedData) {
          sliderDiv.innerHTML = '<span class="reward-item">Error loading rewards</span>';
        }
      }
    }
    
    function displayTopRewards(data) {
      const sliderDiv = document.getElementById('rewards-slider');
      sliderDiv.style.display = 'block';
      if (data.entries && data.entries.length > 0) {
        const rewardsHtml = data.entries.map(entry =>
          `<span class="reward-item">${entry.name} - ${entry.reward.toLocaleString()}</span>`
        ).join(' ‚Ä¢ ');
        
        sliderDiv.innerHTML = rewardsHtml;
      } else {
        sliderDiv.innerHTML = '<span class="reward-item">No rewards data available</span>';
      }
    }
    
    // Fetch top rewards on page load and refresh every 15 minutes
    fetchTopRewards();
    setInterval(fetchTopRewards, 15 * 60 * 1000); // 15 minutes
    
    // Email Modal Functions
    function openEmailModal() {
      document.getElementById('email-modal').style.display = 'block';
    }

    function closeEmailModal() {
      document.getElementById('email-modal').style.display = 'none';
    }

    function savePeersToEmail() {
      const email = document.getElementById('user-email').value;
      if (!email) {
        document.getElementById('email-status').textContent = 'Please enter an email address.';
        return;
      }
      const savedPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');
      const peersToSave = Object.values(savedPeers).map(peer => ({
        peerId: peer.peerId,
        peerName: peer.peerName,
        reward: peer.reward,
        score: peer.score,
        online: peer.online,
        lastUpdated: peer.lastUpdated,
        changes: peer.changes
      }));

      try {
        const data = {
          email: email,
          peers: peersToSave
        };
        const jsonData = JSON.stringify(data);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${email}_gensyn_peers.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        document.getElementById('email-status').textContent = 'Peers saved to email successfully!';
        document.getElementById('email-status').style.color = 'green';
      } catch (err) {
        document.getElementById('email-status').textContent = `Error saving peers to email: ${err.message}`;
        document.getElementById('email-status').style.color = 'red';
      }
    }

    function loadPeersFromEmail() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const loadedData = JSON.parse(text);
          if (loadedData.email && loadedData.peers) {
            const email = loadedData.email;
            const peers = loadedData.peers;
            const existingPeers = JSON.parse(localStorage.getItem(savedPeersKey) || '{}');

            for (const peer of peers) {
              if (existingPeers[peer.peerId]) {
                // Update existing peer
                const oldData = existingPeers[peer.peerId];
                const rewardChange = peer.reward - oldData.reward;
                const scoreChange = peer.score - oldData.score;
                existingPeers[peer.peerId] = {
                  ...peer,
                  lastUpdated: new Date().toISOString(),
                  previousData: {
                    reward: oldData.reward,
                    score: oldData.score,
                    lastUpdated: oldData.lastUpdated
                  },
                  changes: {
                    reward: rewardChange,
                    score: scoreChange
                  }
                };
              } else {
                // New peer
                existingPeers[peer.peerId] = {
                  ...peer,
                  lastUpdated: new Date().toISOString(),
                  previousData: null,
                  changes: {
                    reward: 0,
                    score: 0
                  }
                };
              }
            }
            localStorage.setItem(savedPeersKey, JSON.stringify(existingPeers));
            displaySavedPeers();
            document.getElementById('email-status').textContent = `Peers loaded from ${email} successfully!`;
            document.getElementById('email-status').style.color = 'green';
          } else {
            document.getElementById('email-status').textContent = 'Invalid file format or missing data.';
            document.getElementById('email-status').style.color = 'red';
          }
        } catch (err) {
          document.getElementById('email-status').textContent = `Error loading peers from email: ${err.message}`;
          document.getElementById('email-status').style.color = 'red';
        }
      };
      input.click();
    }

    // Close modal if user clicks outside
    window.onclick = function(event) {
      const emailModal = document.getElementById('email-modal');
      if (event.target == emailModal) {
        closeEmailModal();
      }
    }
    
    // Debug: Check if elements exist
    console.log('Debug: Checking elements...');
    console.log('Top rewards banner:', document.getElementById('top-rewards-banner'));
    console.log('Rewards slider:', document.getElementById('rewards-slider'));
    console.log('Search form:', document.getElementById('search-form'));
    console.log('Saved peers section:', document.getElementById('saved-peers'));
  </script>
</body>
</html>
